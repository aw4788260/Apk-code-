name: ğŸš€ Smart Auto Release

on:
  workflow_dispatch: # ØªØ´ØºÙŠÙ„ ÙŠØ¯ÙˆÙŠ

jobs:
  build_and_release:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Ù„Ø¥Ù†Ø´Ø§Ø¡ Release
      actions: read   # âœ… Ø¶Ø±ÙˆØ±ÙŠ Ù„Ù‚Ø±Ø§Ø¡Ø© Ø³Ø¬Ù„Ø§Øª android-build.yml

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # 1ï¸âƒ£ Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©: Ø¬Ù„Ø¨ Ø¢Ø®Ø± Ø±Ù‚Ù… Ø¨Ù†Ø§Ø¡ ÙˆØ¥Ø¶Ø§ÙØ© 1
      - name: Calculate Next Version
        id: calc_version
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Ø¬Ù„Ø¨ Ø±Ù‚Ù… Ø¢Ø®Ø± Ø¹Ù…Ù„ÙŠØ© ØªØ´ØºÙŠÙ„ Ù„Ù€ android-build.yml
          # Ù†Ø³ØªØ®Ø±Ø¬ Ø§Ù„Ø­Ù‚Ù„ 'number' ÙˆÙ‡Ùˆ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ØªØ³Ù„Ø³Ù„ÙŠ Ù„Ù„Ù€ Run
          LAST_RUN_NUMBER=$(gh run list --workflow android-build.yml --limit 1 --json number --jq '.[0].number')
          
          # ÙÙŠ Ø­Ø§Ù„ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø£ÙŠ ØªØ´ØºÙŠÙ„ Ø³Ø§Ø¨Ù‚ (Ù„Ø£ÙˆÙ„ Ù…Ø±Ø©)
          if [ -z "$LAST_RUN_NUMBER" ] || [ "$LAST_RUN_NUMBER" == "null" ]; then
            LAST_RUN_NUMBER=0
          fi

          # Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø©: Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø§Ø¨Ù‚ + 1
          NEW_VERSION=$((LAST_RUN_NUMBER + 1))
          
          echo "ğŸ” Last Android Build Run: $LAST_RUN_NUMBER"
          echo "ğŸ‰ New Version Code: $NEW_VERSION"
          
          # Ø­ÙØ¸ Ø§Ù„Ù‚ÙŠÙ… Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡Ø§ ÙÙŠ Ø§Ù„Ø®Ø·ÙˆØ§Øª Ø§Ù„ØªØ§Ù„ÙŠØ©
          echo "BUILD_NUMBER=$NEW_VERSION" >> $GITHUB_ENV
          echo "VERSION_TAG=v$NEW_VERSION" >> $GITHUB_ENV

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          cache-disabled: true 
          gradle-version: '8.2' 

      # Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ù„ÙØ§Øª Ø§Ù„ØªØ´ÙÙŠØ±
      - name: Create google-services.json
        env:
          DATA: ${{ secrets.GOOGLE_SERVICES_JSON_B64 }}
        run: |
          echo $DATA | base64 -d > app/google-services.json

      - name: Decode Keystore
        env:
          KEYSTORE_DATA: ${{ secrets.APP_KEYSTORE_BASE64 }}
        run: |
          echo $KEYSTORE_DATA | base64 -d > app/my-upload-key.jks

      # 2ï¸âƒ£ Ø§Ù„Ø¨Ù†Ø§Ø¡ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø­Ø³ÙˆØ¨
      - name: Build Release APK
        env:
          APP_SECRET: ${{ secrets.APP_SECRET }}
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
          # ØªÙ…Ø±ÙŠØ± Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„ÙŠÙƒÙˆÙ† versionCode
          BUILD_NUMBER: ${{ env.BUILD_NUMBER }} 
        run: gradle :app:assembleRelease

      # 3ï¸âƒ£ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ³Ù…ÙŠØ©
      - name: Rename APK
        run: |
          mv app/build/outputs/apk/release/app-release.apk app/build/outputs/apk/release/secure-app-${{ env.VERSION_TAG }}.apk

      # 4ï¸âƒ£ Ø§Ù„Ù†Ø´Ø± Ø¨Ù†ÙØ³ Ø§Ù„Ø±Ù‚Ù…
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        if: success()
        with:
          tag_name: ${{ env.VERSION_TAG }}
          name: ğŸš€ Ø¥ØµØ¯Ø§Ø± ${{ env.VERSION_TAG }}
          body: |
            ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù‡Ø°Ø§ Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø¢Ø®Ø± Ø¹Ù…Ù„ÙŠØ© Ø¨Ù†Ø§Ø¡ Ù†Ø§Ø¬Ø­Ø©.
            - **Ø±Ù‚Ù… Ø§Ù„Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø³Ø§Ø¨Ù‚:** ${{ env.BUILD_NUMBER }} (Ù†Ø§Ù‚Øµ 1)
            - **Ø±Ù‚Ù… Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ:** ${{ env.BUILD_NUMBER }}
            - **Ø§Ù„Ø­Ø§Ù„Ø©:** Ù…ØªØ²Ø§Ù…Ù† ÙˆØªÙ„Ù‚Ø§Ø¦ÙŠ âœ…
          files: app/build/outputs/apk/release/secure-app-${{ env.VERSION_TAG }}.apk
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
