name: ðŸš€ 1-Click Auto Release

on:
  workflow_dispatch: # Ø§Ù„Ø²Ø± Ø§Ù„ÙŠØ¯ÙˆÙŠ

jobs:
  build_and_release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: read

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # --- [ Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ù…ØµØ­Ø­Ø© ] ---
      - name: Calculate Next Version Code
        id: calc_version
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # âœ… ØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„ runNumber Ø¨Ù€ number Ù„ØªÙˆØ§ÙÙ‚ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø¯ÙŠØ¯
          LAST_RUN_NUMBER=$(gh run list --workflow android-build.yml --limit 1 --json number --jq '.[0].number')
          
          # ÙÙŠ Ø­Ø§Ù„ ÙØ´Ù„ Ø§Ù„Ø¬Ù„Ø¨ØŒ Ù†Ø¶Ø¹ Ø±Ù‚Ù…Ø§Ù‹ Ø§Ø­ØªÙŠØ§Ø·ÙŠØ§Ù‹
          if [ -z "$LAST_RUN_NUMBER" ] || [ "$LAST_RUN_NUMBER" == "null" ]; then
            LAST_RUN_NUMBER=350
          fi

          # Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø±Ù‚Ù… Ø¨Ù€ 10 Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø£Ù…Ø§Ù†
          NEW_VERSION_CODE=$((LAST_RUN_NUMBER + 10))
          
          echo "âœ… Last Main Build: $LAST_RUN_NUMBER"
          echo "ðŸš€ New Release Version: $NEW_VERSION_CODE"
          
          echo "BUILD_NUMBER=$NEW_VERSION_CODE" >> $GITHUB_ENV

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          cache-disabled: true 
          gradle-version: '8.2' 

      # --- ÙÙƒ Ø§Ù„ØªØ´ÙÙŠØ± ---
      - name: Create google-services.json
        env:
          DATA: ${{ secrets.GOOGLE_SERVICES_JSON_B64 }}
        run: |
          echo $DATA | base64 -d > app/google-services.json

      - name: Decode Keystore
        env:
          KEYSTORE_DATA: ${{ secrets.APP_KEYSTORE_BASE64 }}
        run: |
          echo $KEYSTORE_DATA | base64 -d > app/my-upload-key.jks

      # --- Ø§Ù„Ø¨Ù†Ø§Ø¡ ---
      - name: Build Release APK
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
          BUILD_NUMBER: ${{ env.BUILD_NUMBER }} 
        run: gradle :app:assembleRelease

      # --- Ø§Ù„Ø¥ØµØ¯Ø§Ø± ---
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        if: success()
        with:
          tag_name: v${{ env.BUILD_NUMBER }}
          name: ðŸš€ ØªØ­Ø¯ÙŠØ« Ø±Ù‚Ù… ${{ env.BUILD_NUMBER }}
          body: |
            ØªÙ… Ø¨Ù†Ø§Ø¡ Ù‡Ø°Ø§ Ø§Ù„Ø¥ØµØ¯Ø§Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.
            - **Ø±Ù‚Ù… Ø§Ù„Ø¨Ù†Ø§Ø¡:** ${{ env.BUILD_NUMBER }}
            - **Ø§Ù„ØªØ§Ø±ÙŠØ®:** ${{ steps.date.outputs.date }}
            - **Ø§Ù„Ø­Ø§Ù„Ø©:** Ø¬Ø§Ù‡Ø² Ù„Ù„ØªØ«Ø¨ÙŠØª âœ…
          files: app/build/outputs/apk/release/app-release.apk
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
