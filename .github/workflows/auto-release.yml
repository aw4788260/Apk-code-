name: ğŸš€ 1-Click Auto Release

on:
  workflow_dispatch: # Ø§Ù„Ø²Ø± Ø§Ù„ÙŠØ¯ÙˆÙŠ

jobs:
  build_and_release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: read # Ø¥Ø°Ù† Ø¥Ø¶Ø§ÙÙŠ Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # --- [ Ø®Ø·ÙˆØ© Ø³Ø­Ø±ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©: Ø¬Ù„Ø¨ Ø¢Ø®Ø± Ø±Ù‚Ù… Ø¨Ù†Ø§Ø¡ ÙˆØ­Ø³Ø§Ø¨Ù‡ ] ---
      - name: Calculate Next Version Code
        id: calc_version
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 1. Ø¬Ù„Ø¨ Ø±Ù‚Ù… Ø¢Ø®Ø± Ø¹Ù…Ù„ÙŠØ© Ø¨Ù†Ø§Ø¡ ØªÙ…Øª ÙÙŠ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ (android-build.yml)
          # Ù…Ù„Ø§Ø­Ø¸Ø©: ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù Ù„Ø¯ÙŠÙƒ Ù‡Ùˆ android-build.yml
          LAST_RUN_NUMBER=$(gh run list --workflow android-build.yml --limit 1 --json runNumber --jq '.[0].runNumber')
          
          # ÙÙŠ Ø­Ø§Ù„ ÙØ´Ù„ Ø§Ù„Ø¬Ù„Ø¨ (Ù„Ø£ÙŠ Ø³Ø¨Ø¨)ØŒ Ù†Ø¶Ø¹ Ø±Ù‚Ù…Ø§Ù‹ Ø§Ø­ØªÙŠØ§Ø·ÙŠØ§Ù‹ ÙƒØ¨ÙŠØ±Ø§Ù‹
          if [ -z "$LAST_RUN_NUMBER" ] || [ "$LAST_RUN_NUMBER" == "null" ]; then
            LAST_RUN_NUMBER=350
          fi

          # 2. Ø­Ø³Ø§Ø¨ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯ (Ù†Ø²ÙˆØ¯ 10 Ù…Ø«Ù„Ø§Ù‹ Ù„Ø¶Ù…Ø§Ù† Ø£Ù†Ù‡ Ø£ÙƒØ¨Ø± Ø¯Ø§Ø¦Ù…Ø§Ù‹)
          # ÙŠÙ…ÙƒÙ†Ùƒ Ø¬Ø¹Ù„Ù‡ +1 ÙÙ‚Ø·ØŒ Ù„ÙƒÙ† +10 Ø£Ø¶Ù…Ù† Ù„ØªÙØ§Ø¯ÙŠ Ø£ÙŠ ØªØ¶Ø§Ø±Ø¨
          NEW_VERSION_CODE=$((LAST_RUN_NUMBER + 10))
          
          echo "âœ… Last Main Build: $LAST_RUN_NUMBER"
          echo "ğŸš€ New Release Version: $NEW_VERSION_CODE"
          
          # ØªØµØ¯ÙŠØ± Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡ ÙÙŠ Ø§Ù„Ø®Ø·ÙˆØ§Øª Ø§Ù„ØªØ§Ù„ÙŠØ©
          echo "BUILD_NUMBER=$NEW_VERSION_CODE" >> $GITHUB_ENV

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          cache-disabled: true 
          gradle-version: '8.2' 

      # --- ÙÙƒ Ø§Ù„ØªØ´ÙÙŠØ± ---
      - name: Create google-services.json
        env:
          DATA: ${{ secrets.GOOGLE_SERVICES_JSON_B64 }}
        run: |
          echo $DATA | base64 -d > app/google-services.json

      - name: Decode Keystore
        env:
          KEYSTORE_DATA: ${{ secrets.APP_KEYSTORE_BASE64 }}
        run: |
          echo $KEYSTORE_DATA | base64 -d > app/my-upload-key.jks

      # --- Ø§Ù„Ø¨Ù†Ø§Ø¡ (Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø­Ø³ÙˆØ¨) ---
      - name: Build Release APK
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
          # âœ… Ù‡Ù†Ø§ Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø°ÙŠ Ø­Ø³Ø¨Ù†Ø§Ù‡ ÙÙŠ Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ø£ÙˆÙ„Ù‰
          BUILD_NUMBER: ${{ env.BUILD_NUMBER }} 
        run: gradle :app:assembleRelease

      # --- Ø§Ù„Ø¥ØµØ¯Ø§Ø± ---
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        if: success()
        with:
          # ØªØ³Ù…ÙŠØ© Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø¨Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯
          tag_name: v${{ env.BUILD_NUMBER }}
          name: ğŸš€ ØªØ­Ø¯ÙŠØ« Ø±Ù‚Ù… ${{ env.BUILD_NUMBER }}
          body: |
            ØªÙ… Ø¨Ù†Ø§Ø¡ Ù‡Ø°Ø§ Ø§Ù„Ø¥ØµØ¯Ø§Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø¢Ø®Ø± Ù†Ø³Ø®Ø©.
            - **Ø±Ù‚Ù… Ø§Ù„Ø¨Ù†Ø§Ø¡:** ${{ env.BUILD_NUMBER }}
            - **Ø§Ù„ØªØ§Ø±ÙŠØ®:** ${{ steps.date.outputs.date }}
            - **Ø§Ù„Ø­Ø§Ù„Ø©:** Ø¬Ø§Ù‡Ø² Ù„Ù„ØªØ«Ø¨ÙŠØª âœ…
          files: app/build/outputs/apk/release/app-release.apk
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
